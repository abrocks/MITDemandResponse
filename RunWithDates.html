<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
        crossorigin="anonymous">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="datAll.js"></script>
    <script src="Bid.js"></script>
    <script src="mitUse.js"></script>
    <head>1.001: MIT Demand Response</head>
    <h2>What if MIT were to participate in a demand response program?</h2>
    <p>Update the Bid</p>
    <input type="number" id="BidPrice" value="20">
    <button onclick="updateBidPrice()">Bid Price, $/MWh</button>

    <input type="number" id="BidAmount" value="1">
    <button onclick="updateBidAmount()">Bid Amount, MW</button>

    <p>Select Dates</p>
    <input type="text" id="startDate" value="04/01/2016">
    <button onclick="run()">Start Date</button>

    <input type="text" id="endDate" value="04/07/2016">
    <button onclick="run()">End Date</button>
    



</head>

<body>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>
    <div id="drawISONEPRicesChart_Div" style="width: 900px; height: 500px;"></div>
    <div id="drawProfitability_Div" style="width: 900px; height: 500px;"></div>
    
    <script type="text/javascript">

    //loading google charts
    google.charts.load('current', { packages: ['corechart', 'line'] });
    google.charts.setOnLoadCallback(drawISONEPRices);
    google.charts.load('current', {packages: ['corechart', 'bar']});
    google.charts.setOnLoadCallback(drawProfit);

//this function isn't recognizing 
$( function() {
    // Initialize date-pickers
    $( "#startDate" ).datepicker({dateFormat: "mm/dd/yy"});
    $( "#endDate" ).datepicker({dateFormat: "mm/dd/yy"});
} );

var ENERGYDAT = ALLDATA.map(t=>{
        var v = {
            date: t[1],
            hourEnding: t[2],
            locationID: t[3],
            locationName: t[4],
            locationType: t[5],
            marginalPrice: t[6],
            energyComponent: t[7],
            congestionComponent: t[8],
            marginalLossComponent: t[9]
        };
        return v;
    });

function run(){
    // Data from ne-iso
    console.log(getDataFromRange());
    // Data from MIT's usage
    console.log(getUsageFromRange());
    updateBidPrice();
    updateBidAmount();
    google.charts.setOnLoadCallback(drawISONEPRices); 
    google.charts.setOnLoadCallback(drawProfit);
}

// Function to get data within time range
function getDataFromRange(startDate, endDate){
    // Set default values
    startDate   = startDate || $('#startDate').val();
    endDate     = endDate || $('#endDate').val();
    // Filter data
    return ENERGYDAT.filter(o => o.date >= startDate && o.date <= endDate);
}

// Function to get data within time range
function getUsageFromRange(startDate, endDate){
    // Set default values
    startDate   = startDate || $('#startDate').val();
    endDate     = endDate || $('#endDate').val();
    // Filter data
    return MITDATA.filter(o => o.date >= startDate && o.date <= endDate);
}

function drawISONEPRices() {
    var ALLDATA2 = getDataFromRange(); 
    var PriceBidGraphableArray = ALLDATA2.map(function (element) {
        var intermediate = [];
        intermediate.push(element[1] + '/' + element[2]);
        intermediate.push(element[6]);
        intermediate.push(BidPrice);
        return intermediate;
    });
    PriceBidGraphableArray.unshift(['Time', 'DAM LMP', "Bid Price"]);
    var gdata = google.visualization.arrayToDataTable(PriceBidGraphableArray);
    var options = {
        title: 'ISO-NE Price versus Bid Price',
        vAxis: { title: 'LMP ($/MWh)' },
        hAxis: { title: 'Time (Month/Day/Year/Hour)' },
        seriesType: 'line',
        series: { 1: { type: 'line' } }
    }
    var chart = new google.visualization.ComboChart(document.getElementById('drawISONEPRicesChart_Div'));
    chart.draw(gdata, options);
        }
         
//tried https://stackoverflow.com/questions/17500312/is-there-some-way-i-can-join-the-contents-of-two-javascript-arrays-much-like-i

function drawProfit(){
    var ALLDATA3 = getDataFromRange(); 
    var MITDATA2 = getUsageFromRange(); 
    var Profit = []; 
    var Use = []; 
    ALLDATA3.forEach(function(element) {
        var profitIntermediate = {}; 
        profitIntermediate.date = element[1];
        profitIntermediate.time = element[2]+':00';
        if(element[6]>=BidPrice){
            profitIntermediate.perUnitProfit= (element[6]-BidPrice)
            }
        else{profitIntermediate.perUnitProfit= 0}
    
        Profit.push(profitIntermediate); 
    });

    MITDATA2.forEach(function(element){
        var DataIntermediate = {};
        if(element.time[3]== '0'){
            DataIntermediate.date = element.date;
            DataIntermediate.time = element.time; 
                if(element.usage/1000 >= BidMW){
                DataIntermediate.MWReduction= BidMW}
                else{DataIntermediate.MWReduction = 0}
            Use.push(DataIntermediate);
            }
        });  
            
    function mergeArrays(a,b){
            arr=[];
        a.forEach(function(element){
            let c={}; 
           b.forEach(function(thing){
               if((element.date===thing.date)&&(element.time===thing.time)){
                   c.date = thing.date;
                   c.time = thing.time;
                   c.profit = element.perUnitProfit*thing.MWReduction; 
                //console.log(c)
                   arr.push(c);
               }
                                 })
                                }); 
                            return arr;
                            }; 
    var joinedArray= mergeArrays(Profit, Use); 
    console.log('this is the joined array'); 
    console.log(joinedArray); 
    var dateArry = [];
    ALLDATA.forEach(function(element){
    if(dateArry.indexOf(element[1])==-1){dateArry.push(element[1])}
    }); 

    var dailyArray = [];
    var currentDate = joinedArray[0].date;
    var currentEntry = {date:currentDate, profit:0}
    joinedArray.forEach(function(elem){
        if(elem.date == currentEntry.date){
            currentEntry.profit += Number(elem.profit)
        } else {
            dailyArray.push([currentEntry.date,currentEntry.profit]);
            currentEntry.date = elem.date;
            currentEntry.profit = 0;
        }
    });            


    dailyArray.unshift(["Date","Profit"]); 
        var data = new google.visualization.arrayToDataTable(dailyArray);
        var options = {
        title: 'Daily Profit',
        hAxis: {
          title: 'Day',
                }, 
        vAxis: {
          title: 'Profit ($)'
                }
        }
        var chart = new google.visualization.ColumnChart(document.getElementById('drawProfitability_Div'));
        chart.draw(data, options);
   }
   
    </script>
    




</body>

</html>